<h1>Aces Up!</h1>

<link href="/assets/css/AcesUp.css" rel="stylesheet">
<script type="text/javascript" src="/assets/webjars/jquery/2.1.3/jquery.js"></script>

<body>

<table>
  <td class="columnOfCards" id="c0">
    <div class='emptyLocation'></div>
    <div class="cardLocation l0"></div>
    <div class="cardLocation l1"></div>
    <div class="cardLocation l2"></div>
    <div class="cardLocation l3"></div>
    <div class="cardLocation l4"></div>
    <div class="cardLocation l5"></div>
    <div class="cardLocation l6"></div>
    <div class="cardLocation l7"></div>
    <div class="cardLocation l8"></div>
    <div class="cardLocation l9"></div>
    <div class="cardLocation l10"></div>
    <div class="cardLocation l11"></div>
    <div class="cardLocation l12"></div>
    <div class="cardLocation l13"></div>
  </td>
  <td class="columnOfCards" id="c1">
    <div class='emptyLocation'></div>
    <div class="cardLocation l0"></div>
    <div class="cardLocation l1"></div>
    <div class="cardLocation l2"></div>
    <div class="cardLocation l3"></div>
    <div class="cardLocation l4"></div>
    <div class="cardLocation l5"></div>
    <div class="cardLocation l6"></div>
    <div class="cardLocation l7"></div>
    <div class="cardLocation l8"></div>
    <div class="cardLocation l9"></div>
    <div class="cardLocation l10"></div>
    <div class="cardLocation l11"></div>
    <div class="cardLocation l12"></div>
    <div class="cardLocation l13"></div>
  </td>
  <td class="columnOfCards" id="c2">
    <div class='emptyLocation'></div>
    <div class="cardLocation l0"></div>
    <div class="cardLocation l1"></div>
    <div class="cardLocation l2"></div>
    <div class="cardLocation l3"></div>
    <div class="cardLocation l4"></div>
    <div class="cardLocation l5"></div>
    <div class="cardLocation l6"></div>
    <div class="cardLocation l7"></div>
    <div class="cardLocation l8"></div>
    <div class="cardLocation l9"></div>
    <div class="cardLocation l10"></div>
    <div class="cardLocation l11"></div>
    <div class="cardLocation l12"></div>
    <div class="cardLocation l13"></div>
  </td>
  <td class="columnOfCards" id="c3">
    <div class='emptyLocation'></div>
    <div class="cardLocation l0"></div>
    <div class="cardLocation l1"></div>
    <div class="cardLocation l2"></div>
    <div class="cardLocation l3"></div>
    <div class="cardLocation l4"></div>
    <div class="cardLocation l5"></div>
    <div class="cardLocation l6"></div>
    <div class="cardLocation l7"></div>
    <div class="cardLocation l8"></div>
    <div class="cardLocation l9"></div>
    <div class="cardLocation l10"></div>
    <div class="cardLocation l11"></div>
    <div class="cardLocation l12"></div>
    <div class="cardLocation l13"></div>
  </td>
</table>
<div id='discard'></div>
<button id="dealButton">48</button>
<script>

var game;

//easy card adjustment variables
//probably should move the css assignment below into the css file itself for the final, up to you guys
var cardHeight = 120;
var cardWidth = cardHeight*.68;
var cardBackgroundColor = 'white';
var cardBorder = 'black solid 1px';
var cardBorderSelected = 'red solid 2px';
var cardBorderRadius = '5px';
var cardMarginTop = -cardHeight;
var marginOffset = 30;
//Card movement variables
var sID; //id of selected element
var colFrom; //column selected card was grabbed from
var colTo; //column card is (attempted at) being assinged to
var position = null; //original position of selected element
var isMove = false; //boolean which stops position variable being set

var halfHeight = cardHeight/2;

var lastCardCenterY = [ halfHeight,
                        halfHeight,
                        halfHeight,
                        halfHeight ];
var lastCardCenterX = -cardWidth/2;
var lastCardIndex = [0,0,0,0];
var curMousePos = {x: -1, y: -1};
var dist = 0;

var score = 0;

function display(game) {
  console.log(game);

  console.log(lastCardIndex);

  $.each(game.cols, function( i, v ){
    $.each(v.cards, function( key, val){
      var x;
      if(val.value > 10){
        if (val.value == 11){
          x = "jack";
        }
        else if (val.value == 12) {
          x = "queen";
        }
        else if (val.value == 13) {
          x = "king";
        }
        else if (val.value == 14){
          x = "ace";
        }
      } else {
        x = val.value;
      }
      var lnk = ("https://raw.githubusercontent.com/hayeah/playing-cards-assets/master/png/"+x+"_of_"+val.suit+".png").toLowerCase();
      var cID = $('#c' + i + ' .l' + key).attr('id', val.value+val.suit); //adds id to element and retrieves it
      $(cID).css({ //sets css for new id (picture card)
        'background':  cardBackgroundColor+' url(' + lnk + ')',
        'background-size': 'contain',
        'background-position': 'center',
        'background-repeat': 'no-repeat',
        'height': cardHeight,
        'width': cardWidth,
        'border': cardBorder,
        'border-radius': cardBorderRadius,
        'position': 'absolute',
        'margin-top': cardMarginTop + (marginOffset * key),
        'z-index': '1',
      });
    });
  });/**/
}
// Calls ApplicationController.gameGet()
$.getJSON("http://localhost:8080/game", function( data ) {
  display(data);
  game = data;
});

$("#dealButton").click(function(){

  if(game.deck.cards.length == 4){
    $('#dealButton').css({
      'display':'none',
    });
  } else {
    $('#dealButton').html(game.deck.cards.length - 4);
  }
  $.each(lastCardIndex, function(i,v){
    lastCardIndex[i] += 1;
    lastCardCenterY[i] = -( marginOffset * lastCardIndex[i] ) + halfHeight;
  });

  $.ajax({
    type: "POST",
    url: "/dealGame",
    data: JSON.stringify(game),
    success: function(data, status){console.log("Data: " + data + "\nStatus: " + status);
          game = data;
          display(data);},
    contentType:"application/json; charset=utf-8",
    dataType:"json",
  });
});

function canRemove(colNumber){
    //lastCardIndex[colNumber];
    var c = game.cols[colNumber].cards[lastCardIndex[colNumber]];
    var removeCard = false;
    console.log(c);
    //Go thru columns to see if there is a larger card of same suit
    for (var i = 0; i < 4; i++) {
        if (i != colNumber) {
            if (lastCardIndex[i] > -1) {
                var compare = game.cols[i].cards[lastCardIndex[i]];
                if (compare.suit == c.suit) {
                    if (compare.value > c.value){
                        removeCard = true;
                    }
                }
            }
        }
    }/**/
    return removeCard;
}

function removeCard(colNumber){
  score+=1;
  lastCardIndex[colNumber]--;
  lastCardCenterY[colNumber] = -( marginOffset * lastCardIndex[colNumber] ) + halfHeight;
  $( sID ).removeAttr('style id'); //kill selected card

  $.ajax({
  type: "POST",
  url: "/removeCard/"+colNumber,
  data: JSON.stringify(game),
  success: function(data, status){console.log("Data: " + data + "\nStatus: " + status);
  game = data;
  display(data);},
  contentType:"application/json; charset=utf-8",
  dataType:"json",
  });
}

function moveCard(cF,cT){

  lastCardIndex[cF]--;
  lastCardCenterY[cF] = -( marginOffset * lastCardIndex[cF] ) + halfHeight;
  lastCardIndex[cT]++;
  lastCardCenterY[cT] = -( marginOffset * lastCardIndex[cT] ) + halfHeight;
  $( sID ).removeAttr('style id'); //kill selected card

  $.ajax({
    type: "POST",
    url: "/moveCard/"+cF+"/"+cT,
    data: JSON.stringify(game),
    success: function(data, status){console.log("Data: " + data + "\nStatus: " + status);
          game = data;
          display(data);},
    contentType:"application/json; charset=utf-8",
    dataType:"json",
  });
}

$("#moveButton").click(function(){
  var cF = $("#from_col").val();
  var cT = $("#to_col").val();
  $.ajax({
    type: "POST",
    url: "/moveCard/"+cF+"/"+cT,
    data: JSON.stringify(game),
    success: function(data, status){console.log("Data: " + data + "\nStatus: " + status);
          game = data;
          display(data);},
    contentType:"application/json; charset=utf-8",
    dataType:"json",
  });
});

//pickup card *********************************************************//
$('div').mousedown(function(e) {
  var fID
  if (this.className.includes('cardLocation')) { //if card
    $.each($(this).parents(), function(i, v) { //look at all parents
      if (v.className == 'columnOfCards') { //find its column
        fID = v.id; //assign related variables
        if (fID == 'c0') {
          colFrom = 0;
          colTo = 0;
        } else if (fID == 'c1') {
          colFrom = 1;
          colTo = 1;
        } else if (fID == 'c2') {
          colFrom = 2;
          colTo = 2;
        } else if (fID == 'c3') {
          colFrom = 3;
          colTo = 3;
        }
        return false; //break each loop
      }
    });
    if (e.target.className == ('cardLocation l' + lastCardIndex[colFrom])) {
      sID = '#' + e.target.id;
      if (!isMove) { //store position if prev mousedown executed
        position = $(sID).position();
        isMove = true;
      }
    } /**/
    $(sID).css({
      'top': curMousePos.y + lastCardCenterY[colFrom],
      'left': curMousePos.x + lastCardCenterX,
      'border': cardBorderSelected,
      'z-index': '999',
    });
  }
});
//drop card ***********************************************************//
$(document).mouseup(function(e) { //release anywhere on the page
  if(sID){
     //console.log(dist);
     /*
    $(sID).animate({
      'left': position.left,
      'top': position.top,
      'z-index':'1',
    },
      dist*.25, 'linear',
    );/**/

    $(sID).css({ //move card out of the way long enough to grab the info of the element behind it
      'left': position.left,
      'top': position.top,
      'display':'none',
      'border': cardBorder,
      'z-index': '1',
    });/**/
    var elem = document.elementFromPoint(e.pageX, e.pageY); //get elemnent at mouse pointer
    $(sID).css({
      'display':'block',
    });
    var tID;
    if ($(elem).is('.emptyLocation')) {
      $.each($(elem).parents(), function(i, v) {
        if (v.className == "columnOfCards") {
          tID = v.id;
          if (tID == 'c0') {
            colTo = 0;
          } else if (tID == 'c1') {
            colTo = 1;
          } else if (tID == 'c2') {
            colTo = 2;
          } else if (tID == 'c3') {
            colTo = 3;
          }
            if(sID.includes('14')){ //is ace, applies "new rule"
              moveCard(colFrom, colTo);
            }
          return false; //break each loop
        }
      });
    } else if ($(elem).is('#discard')) {
      //do discard
      if(canRemove(colFrom)){
        removeCard(colFrom);
        $('#discard').html(score);
      } else {
        console.log('Cant Delete Card');
      }
    }
    colTo = colFrom =sID =null; //release card //unset to and from
    isMove = false;
  }
});
//Move held card around**********************************************//
$(document).mousemove(function(e) {
  curMousePos.x = e.pageX;
  curMousePos.y = e.pageY;
    //$('#discard').html(dist);
    $(sID).css({
      'top': e.pageY + lastCardCenterY[colFrom],
      'left': e.pageX + lastCardCenterX,
    });
});
//*********************************************************************//
</script>

</body>
</html>
